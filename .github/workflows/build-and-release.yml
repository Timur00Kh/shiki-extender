name: Build and Release Chrome Extension

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: packages/extension/package-lock.json

      - name: Install dependencies
        run: |
          cd packages/extension
          npm ci

      - name: Build extension
        run: |
          cd packages/extension
          npm run build

      - name: Create extension zip
        run: |
          cd packages/extension
          npm run zip
          cp .output/*-chrome.zip .output/extension-release.zip

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-zip
          path: packages/extension/.output/extension-release.zip
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension-zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Chrome Extension Release ${{ github.ref_name }}

            ## Installation
            1. Download the ZIP file
            2. Extract it to a folder
            3. Open Chrome and go to `chrome://extensions/`
            4. Enable "Developer mode"
            5. Click "Load unpacked" and select the extracted folder
          files: "*.zip"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-store:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: packages/extension/package-lock.json

      - name: Install dependencies
        run: |
          cd packages/extension
          npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension-zip

      - name: Publish to Chrome Web Store
        run: |
          cd packages/extension
          npx wxt submit --chrome-zip ../../extension-release.zip
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
